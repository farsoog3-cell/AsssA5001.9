<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>mlfa2026 â€” Molfa Embroidery</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root { --bg:#f3f4f6; --card:#ffffff; }
  body{font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:var(--bg); color:#111;}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; background:#111; color:#fff; padding:0.5rem; border-radius:0.5rem;}
  .svg-preview img{ max-width:100%; height:auto; display:block; margin:0 auto; object-fit:contain; }
  .svg-wrap { width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
  @media (max-width:640px){
    header h1{ font-size:1.05rem; }
    .grid-cols-3 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body class="min-h-screen flex flex-col">
<header class="bg-indigo-700 text-white py-4 shadow text-center">
  <h1 class="text-xl md:text-2xl font-semibold">mlfa2026 â€” Molfa Embroidery</h1>
  <p class="text-sm">Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù‘Ù†Ø©: Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ØŒ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©ØŒ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ØºØ±Ø² Ø¯Ù‚ÙŠÙ‚Ø©</p>
</header>

<main class="container mx-auto p-4 md:p-6 flex-grow">
  <div class="bg-white rounded-xl shadow p-4 md:p-6 space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Controls -->
      <div class="space-y-3">
        <label class="block font-medium">Ø±ÙØ¹ ØµÙˆØ±Ø©</label>
        <input id="file" type="file" accept="image/*" class="w-full p-2 border rounded cursor-pointer"/>

        <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
          <div>
            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù†</label>
            <input id="colors" type="number" value="4" min="1" max="12" class="w-full p-2 border rounded"/>
          </div>
          <div>
            <label>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (px)</label>
            <input id="previewW" type="number" value="700" min="200" max="1600" class="w-full p-2 border rounded"/>
          </div>
          <div>
            <label>Ø·ÙˆÙ„ Ø§Ù„ØºØ±Ø²Ø© (px)</label>
            <input id="stitchLen" type="number" value="4" min="1" max="40" class="w-full p-2 border rounded"/>
          </div>
          <div>
            <label>ØªØ¨Ø§Ø¹Ø¯ Ø§Ù„ØºØ±Ø² (px)</label>
            <input id="stitchGap" type="number" value="4" min="1" max="40" class="w-full p-2 border rounded"/>
          </div>
          <div>
            <label>Ø²Ø§ÙˆÙŠØ© Ø§Ù„ØºØ±Ø² (Â°)</label>
            <input id="angle" type="number" value="45" min="0" max="180" class="w-full p-2 border rounded"/>
          </div>
          <div>
            <label>ØªØ¨Ø³ÙŠØ· Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (epsilon)</label>
            <input id="simplify" type="number" value="0.6" step="0.1" min="0" max="10" class="w-full p-2 border rounded"/>
          </div>
        </div>

        <div class="mt-3">
          <label class="block text-sm mb-1">Ù†Ù…Ø· Ø§Ù„ØºØ±Ø²</label>
          <select id="stitchMode" class="w-full p-2 border rounded">
            <option value="fill">Fill â€” ØªØ¹Ø¨Ø¦Ø©</option>
            <option value="satin">Satin â€” Ø³Ø§ØªØ§Ù†</option>
          </select>
        </div>

        <div class="mt-3 flex flex-col sm:flex-row gap-3">
          <button id="process" class="flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700">ğŸ”§ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØºØ±Ø²</button>
          <button id="previewBtn" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded hover:bg-gray-300">ğŸ‘ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
        </div>

        <div class="mt-3 flex flex-col sm:flex-row gap-3">
          <button id="downloadSvg" class="flex-1 bg-blue-600 text-white py-2 rounded hidden">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ SVG</button>
          <button id="downloadDst" class="flex-1 bg-green-600 text-white py-2 rounded hidden">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ DST</button>
          <button id="downloadDse" class="flex-1 bg-pink-600 text-white py-2 rounded hidden">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ DSE</button>
          <button id="downloadPng" class="flex-1 bg-gray-700 text-white py-2 rounded hidden">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ PNG</button>
        </div>

        <div id="spinner" class="hidden mt-4 text-center">
          <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
          </svg>
          <p class="text-sm mt-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© â€” ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ØºØ±Ø² Ø¯Ù‚ÙŠÙ‚Ø©</p>
        </div>

        <p class="mt-3 text-xs text-gray-600 leading-relaxed">
          Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ø³ØªØ®Ø¯Ù… ØµÙˆØ± Ø´ÙØ§ÙØ© Ø£Ùˆ Ø¹Ø§Ù„ÙŠØ© Ø§Ù„ØªØ¨Ø§ÙŠÙ†. Ø¨Ø¹Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ± Ø§ÙØªØ­ SVG ÙÙŠ Ink/Stitch Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©.
        </p>
      </div>

      <!-- Preview & log -->
      <div class="md:col-span-2 space-y-3">
        <div class="bg-gray-50 p-3 rounded min-h-[260px] sm:min-h-[380px] flex items-center justify-center">
          <canvas id="canvasPreview" class="w-full h-full"></canvas>
        </div>

        <div class="bg-black p-3 rounded border">
          <div class="flex items-center justify-between">
            <h4 class="font-bold mb-2 text-white">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</h4>
            <button id="clearLog" class="text-xs text-indigo-400">Ù…Ø³Ø­</button>
          </div>
          <pre id="log" class="mono text-xs h-40 overflow-auto whitespace-pre-wrap"></pre>
        </div>
      </div>
    </div>
  </div>
</main>

<footer class="bg-gray-100 mt-4 p-4 text-center text-sm text-gray-700">
  <p>Ù…Ù† Ù†Ø­Ù†: Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø°ÙŠ Ø¨ÙŠÙ† Ø£ÙŠØ¯ÙŠÙƒÙ… Ù…Ù† Ø¥Ù†ØªØ§Ø¬ Ù…Ø´ØªØ±Ùƒ.</p>
  <p>Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬/Ø§Ù„Ù…Ø·ÙˆØ±: Ù…Ù„Ù‡Ù… ÙˆÙØ§Ø±Ø³</p>
  <p>mlfa2026 Â© 2026</p>
</footer>

<script>
/* ---------- Utilities ---------- */
function log(msg){ const el=document.getElementById('log'); const t=new Date().toLocaleTimeString(); el.textContent+=`[${t}] ${msg}\n`; el.scrollTop=el.scrollHeight; }
function clearLog(){ document.getElementById('log').textContent=''; }
function showSpinner(){ document.getElementById('spinner').classList.remove('hidden'); }
function hideSpinner(){ document.getElementById('spinner').classList.add('hidden'); }
function forceDownload(blob,name){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),2000); }
async function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=e=>res(e.target.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

/* ---------- Worker ---------- */
function makeWorkerFromFunc(fn){ const src=fn.toString(); const blob=new Blob(['('+src+')()'],{type:'application/javascript'}); return new Worker(URL.createObjectURL(blob)); }

const worker = makeWorkerFromFunc(function workerScope(){
  function postLog(m){ try{ postMessage({type:'log', msg:m}); }catch(e){} }
  onmessage = async (ev)=>{
    const msg = ev.data;
    if(msg.type!=='process') return;
    try{
      postLog('Ø¹Ø§Ù…Ù„: Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©');
      const {dataURL, settings} = msg;
      const colors = Math.max(1,Math.min(12,parseInt(settings.colors)||4));
      const previewW = Math.max(120,parseInt(settings.previewW)||600);
      const stitchLen = Math.max(1,parseInt(settings.stitchLen)||4);
      const stitchGap = Math.max(1,parseInt(settings.stitchGap)||4);
      const angle = parseFloat(settings.angle)||45;
      const exportScale = 1;

      // load image
      const img = new Image();
      img.src = dataURL;
      await img.decode();
      const scale = previewW/img.width;
      const w = Math.max(1, Math.round(img.width*scale));
      const h = Math.max(1, Math.round(img.height*scale));

      const off = new OffscreenCanvas(w,h);
      const ctx = off.getContext('2d');
      ctx.clearRect(0,0,w,h);
      ctx.drawImage(img,0,0,w,h);
      postLog(`ØµÙˆØ±Ø© Ù…Ù‚ÙŠØ§Ø³ ${w}x${h}`);

      const id = ctx.getImageData(0,0,w,h);
      const data = id.data;

      // simple quantize
      postLog('ØªØ¬Ø²Ø¦Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†...');
      const samples = [];
      const stepY = Math.max(1, Math.floor(h/100));
      const stepX = Math.max(1, Math.floor(w/100));
      for(let y=0;y<h;y+=stepY) for(let x=0;x<w;x+=stepX){ const i=(y*w+x)*4; samples.push([data[i],data[i+1],data[i+2]]); }

      let centers = [];
      for(let i=0;i<colors;i++) centers.push(samples[Math.floor(Math.random()*samples.length)].slice());
      for(let iter=0;iter<8;iter++){
        const sums=Array.from({length:colors},()=>[0,0,0,0]);
        for(const s of samples){
          let best=0,bd=Infinity;
          for(let j=0;j<colors;j++){
            const c=centers[j];
            const d=(s[0]-c[0])**2+(s[1]-c[1])**2+(s[2]-c[2])**2;
            if(d<bd){ bd=d; best=j; }
          }
          sums[best][0]+=s[0]; sums[best][1]+=s[1]; sums[best][2]+=s[2]; sums[best][3]+=1;
        }
        for(let j=0;j<colors;j++){ if(sums[j][3]>0){ centers[j][0]=Math.round(sums[j][0]/sums[j][3]); centers[j][1]=Math.round(sums[j][1]/sums[j][3]); centers[j][2]=Math.round(sums[j][2]/sums[j][3]); } }
      }
      postLog('Ø§Ù†ØªÙ‡Øª Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø£Ù„ÙˆØ§Ù†');

      const seg = new Uint8Array(w*h);
      for(let y=0;y<h;y++) for(let x=0;x<w;x++){
        const i=(y*w+x)*4; const r=data[i], g=data[i+1], b=data[i+2];
        let best=0,bd=Infinity;
        for(let j=0;j<colors;j++){ const c=centers[j]; const d=(r-c[0])**2+(g-c[1])**2+(b-c[2])**2; if(d<bd){ bd=d; best=j; } }
        seg[y*w+x]=best;
      }

      function collectRegionsForIndex(ci){
        const visited = new Uint8Array(w*h); const regions=[];
        for(let y=0;y<h;y++) for(let x=0;x<w;x++){
          const idx=y*w+x; if(visited[idx]||seg[idx]!==ci) continue;
          const stack=[idx]; visited[idx]=1; let minX=x,maxX=x,minY=y,maxY=y; const pts=[];
          while(stack.length){
            const cur=stack.pop(); const cy=Math.floor(cur/w), cx=cur-cy*w; pts.push([cx,cy]);
            if(cx<minX) minX=cx; if(cx>maxX) maxX=cx; if(cy<minY) minY=cy; if(cy>maxY) maxY=cy;
            const nbs=[cur-1,cur+1,cur-w,cur+w];
            for(const nb of nbs){
              if(nb<0||nb>=w*h) continue;
              if(visited[nb]) continue;
              if(seg[nb]===ci){ visited[nb]=1; stack.push(nb); }
            }
          }
          regions.push({pts,bbox:[minX,minY,maxX,maxY],ci});
        }
        return regions;
      }

      const allColorStitches=[];
      const angleRad=angle*Math.PI/180;

      function generateFillStitches(region){
        const mask = new Uint8Array(w*h);
        for(const p of region.pts) mask[p[1]*w+p[0]]=1;
        const stitches=[]; const [minX,minY,maxX,maxY] = region.bbox;
        const gap = Math.max(1, stitchGap);
        const cosA = Math.cos(angleRad), sinA = Math.sin(angleRad);
        const cx = (minX+maxX)/2, cy=(minY+maxY)/2;

        for(let y=minY-1;y<=maxY+1;y+=gap){
          let run=[];
          for(let x=minX-1;x<=maxX+1;x++){
            if(x<0||y<0||x>=w||y>=h){ if(run.length>1) run.forEach(pt=>stitches.push(pt)); run=[]; continue; }
            if(mask[y*w+x]){
              const rx = Math.round(cosA*(x-cx)-sinA*(y-cy)+cx);
              const ry = Math.round(sinA*(x-cx)+cosA*(y-cy)+cy);
              run.push([rx,ry]);
            } else { if(run.length>1) run.forEach(pt=>stitches.push(pt)); run=[]; }
          }
          if(run.length>1) run.forEach(pt=>stitches.push(pt));
        }

        const finalStitches=[];
        for(let i=0;i<stitches.length;i+=stitchLen) finalStitches.push([stitches[i][0],stitches[i][1],i===0,region.ci]);
        return finalStitches;
      }

      for(let ci=0;ci<colors;ci++){
        postLog(`Ø¹Ø§Ù…Ù„: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù„ÙˆÙ† ${ci+1}/${colors}...`);
        const regions=collectRegionsForIndex(ci);
        for(const reg of regions){ if(reg.pts.length<5) continue; const pts=generateFillStitches(reg); if(pts.length) allColorStitches.push(...pts); }
      }

      if(allColorStitches.length===0){ 
        postLog('Ø¹Ø§Ù…Ù„: Ù„Ù… ØªÙÙˆÙ„Ù‘ÙØ¯ ØºØ±Ø²'); 
        const emptySvg=`<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'><rect width='100%' height='100%' fill='white'></rect></svg>`; 
        postMessage({ svg:emptySvg, dstBuffer:new ArrayBuffer(0), dseBuffer:new ArrayBuffer(0), width:w, height:h, notes:'no-stitches' }); 
        return; 
      }

      function toExportCoord(px){ return Math.round(px*exportScale); }
      function buildDstBytes(points,label){
        const header=new Uint8Array(512);
        const name=('LA:'+ (label||'MOLFA')+'\n').slice(0,80);
        for(let i=0;i<name.length && i<512;i++) header[i]=name.charCodeAt(i);
        const body=[]; let prevx=0,prevy=0;
        for(const p of points){
          const x=toExportCoord(p[0]), y=toExportCoord(p[1]); const isJump=!!p[2];
          let dx=x-prevx, dy=y-prevy;
          while(Math.abs(dx)>127||Math.abs(dy)>127){
            const sx=Math.max(-121,Math.min(121,dx)), sy=Math.max(-121,Math.min(121,dy));
            body.push(0x80 | ((sx>>7)&0x01) | ((sy>>6)&0x01)); body.push(sx&0x7f); body.push(sy&0x7f);
            dx-=sx; dy-=sy; prevx+=sx; prevy+=sy;
          }
          body.push(isJump?0x80:0x00); body.push(dx&0xff); body.push(dy&0xff); prevx=x; prevy=y;
        }
        return new Uint8Array([...header,...body]);
      }

      const dstBuffer=buildDstBytes(allColorStitches,'MLFA');
      const dseBuffer=buildDstBytes(allColorStitches,'MLFA');

      let svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">`;
      svg+=`<rect width="100%" height="100%" fill="white"></rect>`;
      for(const p of allColorStitches) svg+=`<circle cx="${p[0]}" cy="${p[1]}" r="1" fill="black"></circle>`;
      svg+=`</svg>`;

      postLog('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©');
      postMessage({svg,dstBuffer,dseBuffer,width:w,height:h,stitches:allColorStitches});
    }catch(e){ postLog('Ø®Ø·Ø£ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: '+(e.message||e)); postMessage({error:e.message}); }
  };
});

/* ---------- Main ---------- */
document.getElementById('clearLog').onclick = clearLog;

document.getElementById('process').onclick = async ()=>{
  const file = document.getElementById('file').files[0];
  if(!file){ alert('Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
  showSpinner(); clearLog();
  const dataURL = await readFileAsDataURL(file);
  const settings={
    colors:document.getElementById('colors').value,
    previewW:document.getElementById('previewW').value,
    stitchLen:document.getElementById('stitchLen').value,
    stitchGap:document.getElementById('stitchGap').value,
    angle:document.getElementById('angle').value,
    simplify:document.getElementById('simplify').value,
    mode:document.getElementById('stitchMode').value
  };
  worker.postMessage({type:'process', dataURL, settings});
};

worker.onmessage = function(e){
  hideSpinner();
  const msg = e.data;
  if(msg.type==='log') log(msg.msg);
  if(msg.svg){
    const canvas = document.getElementById('canvasPreview');
    canvas.width = msg.width; canvas.height = msg.height;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Ø±Ø³Ù… Ø§Ù„ØºØ±Ø² Ø¨Ø¯Ù‚Ø© Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªØ´ÙˆÙŠÙ‡
    for(const p of msg.stitches){
      ctx.fillStyle='black';
      ctx.fillRect(p[0],p[1],1,1);
    }

    ['downloadSvg','downloadDst','downloadDse','downloadPng'].forEach(id=>document.getElementById(id).classList.remove('hidden'));

    document.getElementById('downloadSvg').onclick = ()=>{ const blob=new Blob([msg.svg],{type:'image/svg+xml'}); forceDownload(blob,'mlfa.svg'); };
    document.getElementById('downloadDst').onclick = ()=>{ const blob=new Blob([msg.dstBuffer],{type:'application/octet-stream'}); forceDownload(blob,'mlfa.dst'); };
    document.getElementById('downloadDse').onclick = ()=>{ const blob=new Blob([msg.dseBuffer],{type:'application/octet-stream'}); forceDownload(blob,'mlfa.dse'); };
    document.getElementById('downloadPng').onclick = ()=>{
      canvas.toBlob(blob=>forceDownload(blob,'mlfa.png'));
    };
  }
};

document.getElementById('previewBtn').onclick = ()=>{
  const canvas = document.getElementById('canvasPreview');
  if(canvas.width===0 || canvas.height===0) canvas.getContext('2d').fillText('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ø¹Ø¯', 10,20);
};
</script>
</body>
</html>
