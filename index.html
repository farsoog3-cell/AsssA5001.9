<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Molfa â€” ØªØ­ÙˆÙŠÙ„ ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ØªØ·Ø±ÙŠØ² DST</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{font-family:Inter,system-ui,Arial; background:#f3f4f6; color:#111;}
.mono{font-family:ui-monospace,monospace;}
.svg-wrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
button{cursor:pointer;}
</style>
</head>
<body class="min-h-screen flex flex-col">
<header class="bg-indigo-700 text-white py-4 shadow text-center">
<h1 class="text-xl font-semibold">Molfa â€” ØªØ­ÙˆÙŠÙ„ ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ØªØ·Ø±ÙŠØ² DST</h1>
<p>Ø§Ø®ØªØ± ØµÙˆØ±Ø©ØŒ Ø´Ø§Ù‡Ø¯ Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ù…Ø·Ø±Ø²ØŒ ÙˆØ­Ù…Ù‘Ù„ Ù…Ù„Ù DST Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</p>
</header>

<main class="container mx-auto p-4 md:p-6 flex-grow">
<div class="bg-white rounded-xl shadow p-4 md:p-6">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">

<div>
<label class="block font-medium">Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
<input id="file" type="file" accept="image/*" class="w-full p-2 border rounded mt-1"/>

<div class="mt-3">
<label class="text-sm block mb-1">Ø­Ø¬Ù… Ø§Ù„Ø®Ù„ÙŠØ© (px)</label>
<input id="cellSize" type="number" min="2" max="20" value="6" class="w-full p-2 border rounded"/>
</div>

<div class="mt-3">
<label class="text-sm block mb-1">Ø·ÙˆÙ„ Ø§Ù„ØºØ±Ø²Ø© (px)</label>
<input id="stitchStep" type="number" min="1" max="16" value="3" class="w-full p-2 border rounded"/>
</div>

<div class="mt-3">
<label class="text-sm block mb-1">Ø¹Ø¯Ø¯ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø®ÙŠÙˆØ·</label>
<input id="numThreads" type="number" min="2" max="10" value="5" class="w-full p-2 border rounded"/>
</div>

<div class="mt-4 flex flex-col gap-2">
<button id="process" class="bg-indigo-600 text-white py-2 rounded">ğŸ”§ ØªÙˆÙ„ÙŠØ¯ ØªØ·Ø±ÙŠØ²</button>
<button id="createDST" class="bg-purple-600 text-white py-2 rounded" disabled>ğŸ“„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù DST</button>
<button id="downloadDST" class="bg-green-600 text-white py-2 rounded" disabled>â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ DST</button>
</div>

<div class="mt-3">
<h2 class="font-semibold">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±Ø² (JSON)</h2>
<pre id="stitchData" class="mono text-xs h-40 overflow-auto whitespace-pre-wrap bg-gray-100 p-2 rounded border mt-2"></pre>
</div>

</div>

<div class="md:col-span-2">
<div class="bg-gray-50 p-3 rounded min-h-[380px] flex items-center justify-center">
<div id="svgPreview" class="svg-wrap text-gray-500">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ø¹Ø¯</div>
</div>
<pre id="log" class="mono text-xs h-40 overflow-auto whitespace-pre-wrap bg-white p-2 rounded border mt-3"></pre>
</div>

</div>
</div>
</main>

<script>
function log(msg){
  const el=document.getElementById('log');
  el.textContent += '['+new Date().toLocaleTimeString()+'] '+msg+"\n";
  el.scrollTop = el.scrollHeight;
}
function forceDownload(blob,name){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=name;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),2000);
}

// Ø£Ù„ÙˆØ§Ù† Ø®ÙŠÙˆØ· Ù…Ø´Ù‡ÙˆØ±Ø©
const threadColors=["rgb(0,0,0)","rgb(255,0,0)","rgb(0,255,0)","rgb(0,0,255)","rgb(255,255,0)","rgb(255,0,255)","rgb(0,255,255)"];

function buildDST(coords){
  const header=new Uint8Array(512);
  const body=[];
  let prevx=0,prevy=0;
  coords.forEach(p=>{
    let x=Math.round(p[0]),y=Math.round(p[1]);
    let dx=x-prevx,dy=y-prevy;
    while(Math.abs(dx)>121||Math.abs(dy)>121){
      const sx=Math.max(-121,Math.min(121,dx));
      const sy=Math.max(-121,Math.min(121,dy));
      body.push(sx&0xFF,sy&0xFF,0x01);
      dx-=sx; dy-=sy; prevx+=sx; prevy+=sy;
    }
    body.push(dx&0xFF,dy&0xFF,0x03);
    prevx=x; prevy=y;
  });
  body.push(0x00,0x00,0xF3);
  const arr=new Uint8Array(512+body.length);
  arr.set(header,0);
  arr.set(new Uint8Array(body),512);
  return arr;
}

const fileInput=document.getElementById('file');
const btn=document.getElementById('process');
const createBtn=document.getElementById('createDST');
const downloadBtn=document.getElementById('downloadDST');
const preview=document.getElementById('svgPreview');

let merged=[], dstFile=null, mergedColors=[];

btn.addEventListener('click',()=>{
  const f=fileInput.files[0];
  if(!f){ alert('Ø§Ø®ØªØ± ØµÙˆØ±Ø©'); return; }

  const cellSize=Number(document.getElementById('cellSize').value||6);
  const stitchStep=Number(document.getElementById('stitchStep').value||3);
  const numThreads=Number(document.getElementById('numThreads').value||5);
  const reader=new FileReader();
  reader.onload=async()=>{
    const imgBlob=await (await fetch(reader.result)).blob();
    const img=await createImageBitmap(imgBlob);

    const scale=Math.min(300/img.width,300/img.height,1);
    const w=Math.floor(img.width*scale), h=Math.floor(img.height*scale);
    const off=new OffscreenCanvas(w,h);
    const ctx=off.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    const id=ctx.getImageData(0,0,w,h).data;

    merged=[]; mergedColors=[];
    for(let y=0;y<h;y+=cellSize){
      for(let x=0;x<w;x+=cellSize){
        let rSum=0,gSum=0,bSum=0,cnt=0;
        for(let yy=y;yy<y+cellSize && yy<h;yy++){
          for(let xx=x;xx<x+cellSize && xx<w;xx++){
            const i=(yy*w+xx)*4;
            rSum+=id[i]; gSum+=id[i+1]; bSum+=id[i+2]; cnt++;
          }
        }
        const r=Math.round(rSum/cnt),g=Math.round(gSum/cnt),b=Math.round(bSum/cnt);
        let minDist=Infinity, chosen=threadColors[0];
        for(const c of threadColors.slice(0,numThreads)){
          const m=c.match(/\d+/g);
          const dr=r-m[0], dg=g-m[1], db=b-m[2];
          const dist=dr*dr+dg*dg+db*db;
          if(dist<minDist){ minDist=dist; chosen=c; }
        }
        merged.push([x+cellSize/2,y+cellSize/2]);
        mergedColors.push(chosen);
      }
    }

    // SVG Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    let svg=`<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}' viewBox='0 0 ${w} ${h}'>`;
    svg+=`<rect width='100%' height='100%' fill='white'></rect>`;
    for(let i=0;i<merged.length;i++){
      svg+=`<circle cx='${merged[i][0]}' cy='${merged[i][1]}' r='1' fill='${mergedColors[i]}'/>`;
    }
    svg+=`</svg>`;
    preview.innerHTML=`<object type="image/svg+xml" data="data:image/svg+xml;base64,${btoa(svg)}" style="width:100%;height:100%"></object>`;

    const stitchJSON=merged.map((p,i)=>({index:i+1,x:p[0],y:p[1],color:mergedColors[i]}));
    document.getElementById('stitchData').textContent=JSON.stringify(stitchJSON,null,2);

    log('ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ØªØ·Ø±ÙŠØ² â€” ØºØ±Ø²: '+merged.length);
    createBtn.disabled=false;
  };
  reader.readAsDataURL(f);
});

createBtn.addEventListener('click',()=>{
  if(!merged.length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙ…ÙŠÙ… Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù'); return; }
  dstFile=buildDST(merged);
  log('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù DST Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ');
  downloadBtn.disabled=false;
});

downloadBtn.addEventListener('click',()=>{
  if(!dstFile){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù„Ù„ØªÙ†Ø²ÙŠÙ„'); return; }
  forceDownload(new Blob([dstFile],{type:'application/octet-stream'}),'molfa_output.dst');
  log('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ');
});
</script>
</body>
</html>
