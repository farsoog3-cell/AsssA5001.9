<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>أداة تطريز دقة DST متقدمة</title>
<style>
:root{
  --bg:#0f172a;
  --card:#0b1220;
  --accent:#06b6d4;
  --muted:#94a3b8;
  --glass: rgba(255,255,255,0.04);
  --radius:12px;
  --glass-2: rgba(255,255,255,0.02);
}
html,body{
  height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
  direction:rtl;background:linear-gradient(180deg,#071029 0%, #071a2b 100%);color:#e6eef6
}
.app{
  display:grid;grid-template-columns:320px 1fr;gap:20px;height:100vh;padding:24px
}
.panel{
  background:linear-gradient(180deg,var(--card),#051022);
  border-radius:var(--radius);padding:18px;
  box-shadow:0 6px 30px rgba(0,0,0,0.6);
  backdrop-filter: blur(6px)
}
h1{font-size:18px;margin:0 0 8px}
p.lead{color:var(--muted);font-size:13px;margin:0 0 14px}
.tool{display:flex;flex-direction:column;gap:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--accent);font-weight:600}
.btn.secondary{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
.controls{display:flex;gap:8px;align-items:center}
.color-swatch{width:30px;height:30px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);cursor:pointer}
input[type=range]{width:120px}
.stage{display:flex;flex-direction:column;gap:8px}
.canvas-wrap{flex:1;background:var(--glass-2);border-radius:12px;padding:12px;display:flex;flex-direction:column}
.canvas-card{flex:1;display:flex;justify-content:center;align-items:center;position:relative}
canvas{background:#f8fafc;border-radius:8px;touch-action:none;max-width:100%;box-shadow:inset 0 0 0 1px rgba(0,0,0,0.05)}
.footer{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px;margin-top:6px}
@media (max-width:880px){.app{grid-template-columns:1fr;overflow:auto;padding:12px}.panel{order:2}}
</style>
</head>
<body>
<div class="app">
<aside class="panel">
<h1>أداة تطريز متقدمة</h1>
<p class="lead">ارسم باللمس أو الفأرة، أي شكل يظهر بدقة في ملف DST.</p>
<div class="tool">
<div class="row">
<button class="btn" id="newBtn">جديد</button>
<button class="btn secondary" id="undoBtn">تراجع</button>
</div>
<div class="row">
<div class="controls">
<label style="color:var(--muted);font-size:13px">حجم الإبرة</label>
<input type="range" id="size" min="1" max="40" value="3">
<span id="sizeVal" style="width:34px;text-align:center;color:var(--muted)">3</span>
</div>
</div>
<div class="row">
<label style="color:var(--muted);font-size:13px;margin-bottom:6px">ألوان الخيط</label>
</div>
<div class="row" id="colors"></div>
<div class="row">
<button class="btn" id="saveJson">حفظ كقالب (JSON)</button>
</div>
<div class="row">
<button class="btn" id="exportSvg">تصدير SVG</button>
<button class="btn" id="exportPng">تصدير PNG</button>
</div>
<div class="row">
<button class="btn" id="exportDst">تصدير DST</button>
</div>
</div>
</aside>

<main class="stage panel">
<div style="display:flex;justify-content:space-between;align-items:center"><strong>لوحة الرسم</strong></div>
<div class="canvas-wrap">
<div class="canvas-card">
<canvas id="draw" width="1200" height="800"></canvas>
</div>
<div class="footer">
<div id="info">المسارات: 0</div>
<div>تنسيقات: SVG / PNG / DST / JSON</div>
</div>
</div>
</main>
</div>

<script>
const canvas=document.getElementById('draw'),ctx=canvas.getContext('2d');
let strokes=[],current=null,drawing=false;
const sizeInput=document.getElementById('size'),sizeVal=document.getElementById('sizeVal');
const palette=['#0f172a','#06b6d4','#ef4444','#f59e0b','#10b981','#7c3aed','#f97316','#111827'];
let currentColor=palette[1];
const colorsEl=document.getElementById('colors');

// إنشاء لوحة الألوان
palette.forEach(c=>{
  const b=document.createElement('div');
  b.className='color-swatch';
  b.style.background=c;
  b.addEventListener('click',()=>{currentColor=c;colorsEl.querySelectorAll('.color-swatch').forEach(s=>s.style.border='1px solid rgba(255,255,255,0.06)');b.style.border='2px solid #06b6d4';});
  colorsEl.appendChild(b);
});

// التحكم بحجم الإبرة
sizeInput.addEventListener('input',()=>{sizeVal.textContent=sizeInput.value;});

// الحصول على إحداثيات المؤشر
function getPointer(e){
  const r=canvas.getBoundingClientRect();
  const p=e.touches?e.touches[0]:e;
  return {x:Math.max(0,Math.min(r.width,p.clientX-r.left)),y:Math.max(0,Math.min(r.height,p.clientY-r.top))};
}

// البداية والتحريك والنهاية
function begin(x,y){drawing=true;current={color:currentColor,size:parseInt(sizeInput.value,10),points:[{x,y}]};strokes.push(current);updateInfo();}
function move(x,y){if(!drawing||!current)return;current.points.push({x,y});drawSegment(current);}
function end(){drawing=false;current=null;updateInfo();}

// رسم جزء من المسار
function drawSegment(s){
  const p=s.points,n=p.length;if(n<2)return;
  ctx.lineCap='round';ctx.lineJoin='round';ctx.strokeStyle=s.color;ctx.lineWidth=s.size;
  ctx.beginPath();ctx.moveTo(p[n-2].x,p[n-2].y);
  ctx.lineTo(p[n-1].x,p[n-1].y);ctx.stroke();
}

// رسم كامل المسار
function drawFull(s){
  if(s.points.length<2)return;
  ctx.lineCap='round';ctx.lineJoin='round';ctx.strokeStyle=s.color;ctx.lineWidth=s.size;
  ctx.beginPath();ctx.moveTo(s.points[0].x,s.points[0].y);
  for(let i=1;i<s.points.length;i++)ctx.lineTo(s.points[i].x,s.points[i].y);
  ctx.stroke();
}

// إعادة الرسم بالكامل
function redraw(){ctx.clearRect(0,0,canvas.width,canvas.height);strokes.forEach(drawFull);}
function updateInfo(){document.getElementById('info').textContent=`المسارات: ${strokes.length}`;}

// أحداث الفأرة/اللمس
canvas.addEventListener('pointerdown',e=>{canvas.setPointerCapture(e.pointerId);const p=getPointer(e);begin(p.x,p.y);});
canvas.addEventListener('pointermove',e=>{if(!drawing)return;const p=getPointer(e);move(p.x,p.y);});
canvas.addEventListener('pointerup',e=>{canvas.releasePointerCapture(e.pointerId);end();});
canvas.addEventListener('pointercancel',end);

// أزرار التحكم
document.getElementById('undoBtn').addEventListener('click',()=>{if(strokes.length){strokes.pop();redraw();updateInfo();}});
document.getElementById('newBtn').addEventListener('click',()=>{if(confirm('مسح الرسم الحالي؟')){strokes=[];redraw();updateInfo();}});

// الحفظ والتصدير
document.getElementById('saveJson').addEventListener('click',()=>{downloadData(JSON.stringify({strokes},null,2),'embroidery-template.json','application/json');});
document.getElementById('exportSvg').addEventListener('click',()=>{downloadData(strokesToSVG(),'embroidery.svg','image/svg+xml');});
document.getElementById('exportPng').addEventListener('click',()=>{exportPNG();});
document.getElementById('exportDst').addEventListener('click',()=>{downloadData(strokesToDST(strokes,canvas.width,canvas.height),'embroidery.dst','application/octet-stream');});

// ======= تحسين PNG =======
function exportPNG(){
  const tmp=document.createElement('canvas');tmp.width=canvas.width;tmp.height=canvas.height;
  const tctx=tmp.getContext('2d');tctx.fillStyle='#ffffff';tctx.fillRect(0,0,tmp.width,tmp.height);
  strokes.forEach(drawFull=>{drawFull(drawFull)});
  tmp.toBlob(b=>downloadBlob(b,'embroidery.png'));
}

// ======= تحويل إلى SVG =======
function strokesToSVG(){
  let svg=`<?xml version="1.0"?><svg xmlns='http://www.w3.org/2000/svg' width='${canvas.width}' height='${canvas.height}' viewBox='0 0 ${canvas.width} ${canvas.height}'>`;
  svg+=`<rect width='100%' height='100%' fill='white'/>`;
  strokes.forEach(s=>{
    if(s.points.length<2)return;
    const d=s.points.map((p,i)=>i===0?`M ${p.x} ${p.y}`:`L ${p.x} ${p.y}`).join(' ');
    svg+=`<path d='${d}' stroke='${s.color}' stroke-width='${s.size}' fill='none' stroke-linecap='round' stroke-linejoin='round'/>`;
  });
  svg+='</svg>';
  return svg;
}

// ======= تحسين DST =======
function catmullRomSpline(points, numPoints = 10){
  if(points.length<2)return points;
  const newPts=[];
  for(let i=0;i<points.length-1;i++){
    const p0 = points[i-1]||points[i];
    const p1 = points[i];
    const p2 = points[i+1];
    const p3 = points[i+2]||p2;
    for(let t=0;t<numPoints;t++){
      const tt=t/numPoints;
      const tt2=tt*tt; const tt3=tt2*tt;
      const x = 0.5*((2*p1.x)+(-p0.x+p2.x)*tt+(2*p0.x-5*p1.x+4*p2.x-p3.x)*tt2+(-p0.x+3*p1.x-3*p2.x+p3.x)*tt3);
      const y = 0.5*((2*p1.y)+(-p0.y+p2.y)*tt+(2*p0.y-5*p1.y+4*p2.y-p3.y)*tt2+(-p0.y+3*p1.y-3*p2.y+p3.y)*tt3);
      newPts.push({x,y});
    }
  }
  newPts.push(points[points.length-1]);
  return newPts;
}

function strokesToDST(strokes,width,height){
  const header=new Uint8Array(512);
  const body=[];
  let lastX=0,lastY=0;
  const scale=1;
  for(let s of strokes){
    const pts=catmullRomSpline(s.points,5);
    for(let p of pts){
      let x=Math.round(p.x*scale), y=Math.round(p.y*scale);
      let dx=x-lastX, dy=-(y-lastY);
      while(Math.abs(dx)>121||Math.abs(dy)>121){
        const stepX=Math.max(-121,Math.min(121,dx));
        const stepY=Math.max(-121,Math.min(121,dy));
        body.push(stepX&0xFF,stepY&0xFF,0);
        dx-=stepX; dy-=stepY;
      }
      body.push(dx&0xFF,dy&0xFF,0);
      lastX=x; lastY=y;
    }
  }
  body.push(0x1A,0,0);
  const result=new Uint8Array(header.length+body.length);
  result.set(header,0);
  result.set(body,header.length);
  return result.buffer;
}

// ======= تحميل البيانات =======
function downloadData(data,name,type){
  const blob=new Blob([data],{type});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=name;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function downloadBlob(b,name){downloadData(b,name,'application/octet-stream');}
</script>
</body>
</html>
