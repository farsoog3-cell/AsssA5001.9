<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Molfa â€” ØµÙˆØ±Ø© â†’ DST ÙƒØ§Ù…Ù„</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{font-family:Inter,system-ui,Arial; background:#f3f4f6; color:#111;}
.mono{font-family:ui-monospace,monospace;}
.svg-wrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
button{cursor:pointer;}
</style>
</head>
<body class="min-h-screen flex flex-col">
<header class="bg-indigo-700 text-white py-4 shadow text-center">
<h1 class="text-xl font-semibold">Molfa â€” ØµÙˆØ±Ø© â†’ DST ÙƒØ§Ù…Ù„</h1>
<p>Ø±ÙØ¹ ØµÙˆØ±Ø© â†’ ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù…Ø®Ø·Ø· â†’ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù DST â†’ Ø­ÙØ¸ Ø§Ù„ØªØµÙ…ÙŠÙ… â†’ ØªÙ†Ø²ÙŠÙ„</p>
</header>

<main class="container mx-auto p-4 md:p-6 flex-grow">
<div class="bg-white rounded-xl shadow p-4 md:p-6">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div>
<label class="block font-medium">Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
<input id="file" type="file" accept="image/*" class="w-full p-2 border rounded"/>

<div class="mt-3">
<label class="text-sm block mb-1">Ø­Ø¬Ù… Ø§Ù„Ø®Ù„ÙŠØ© (px)</label>
<input id="cellSize" type="number" min="4" max="40" value="8" class="w-full p-2 border rounded"/>
</div>

<div class="mt-3">
<label class="text-sm block mb-1">Ø¹ØªØ¨Ø© Ø§Ù„Ø£Ø¨ÙŠØ¶/Ø£Ø³ÙˆØ¯</label>
<input id="bwThreshold" type="range" min="0" max="255" value="128"/>
</div>

<div class="mt-3">
<label class="text-sm block mb-1">Ø·ÙˆÙ„ Ø§Ù„ØºØ±Ø²Ø© Ø¯Ø§Ø®Ù„ X (px)</label>
<input id="stitchStep" type="number" min="1" max="16" value="4" class="w-full p-2 border rounded"/>
</div>

<div class="mt-3">
<label class="text-sm block mb-1">Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„ØªØµØ¯ÙŠØ± (px â†’ 0.1mm)</label>
<input id="exportScale" type="number" value="0.2" step="0.05" min="0.05" max="5" class="w-full p-2 border rounded"/>
</div>

<div class="mt-4 flex flex-col gap-2">
<button id="process" class="bg-indigo-600 text-white py-2 rounded">ğŸ”§ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø®Ø·Ø·</button>
<button id="createDST" class="bg-purple-600 text-white py-2 rounded" disabled>ğŸ“„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù DST</button>
<button id="saveDST" class="bg-yellow-600 text-white py-2 rounded" disabled>ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØµÙ…ÙŠÙ… ÙÙŠ Ø§Ù„Ù…Ù„Ù</button>
<button id="downloadDST" class="bg-green-600 text-white py-2 rounded" disabled>â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
</div>
</div>

<div class="md:col-span-2">
<div class="bg-gray-50 p-3 rounded min-h-[380px] flex items-center justify-center">
<div id="svgPreview" class="svg-wrap text-gray-500">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ø¹Ø¯</div>
</div>
<pre id="log" class="mono text-xs h-40 overflow-auto whitespace-pre-wrap bg-white p-2 rounded border mt-3"></pre>
</div>
</div>
</div>
</main>

<script>
function log(msg){ 
  const el=document.getElementById('log'); 
  el.textContent += '['+new Date().toLocaleTimeString()+'] '+msg + "\n"; 
  el.scrollTop = el.scrollHeight; 
}
function forceDownload(blob,name){ 
  const url=URL.createObjectURL(blob); 
  const a=document.createElement('a'); 
  a.href=url; a.download=name; 
  document.body.appendChild(a); 
  a.click(); 
  a.remove(); 
  setTimeout(()=>URL.revokeObjectURL(url),2000); 
}

function buildDST(coords){
  const header = new Uint8Array(512);
  const body=[];
  let prevx=0, prevy=0;
  coords.forEach(p=>{
    let x=Math.round(p[0]), y=Math.round(p[1]);
    let dx=x-prevx, dy=y-prevy;
    while(Math.abs(dx)>121 || Math.abs(dy)>121){
      const sx=Math.max(-121,Math.min(121,dx));
      const sy=Math.max(-121,Math.min(121,dy));
      body.push(sx&0xFF, sy&0xFF, 0x01);
      dx-=sx; dy-=sy; prevx+=sx; prevy+=sy;
    }
    body.push(dx&0xFF, dy&0xFF, 0x03);
    prevx=x; prevy=y;
  });
  body.push(0x00,0x00,0xF3);
  const arr=new Uint8Array(512+body.length);
  arr.set(header,0);
  arr.set(new Uint8Array(body),512);
  return arr;
}

function makeWorkerFromFunc(fn){ 
  const src = fn.toString(); 
  const blob=new Blob(['('+src+')()'],{type:'application/javascript'}); 
  return new Worker(URL.createObjectURL(blob)); 
}

// Worker Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù…Ø®Ø·Ø· ØºØ±Ø²
const worker=makeWorkerFromFunc(function(){
  onmessage=async ev=>{
    const {dataURL, cellSize, bwThreshold, stitchStep, exportScale}=ev.data;
    try{
      const imgBlob=await (await fetch(dataURL)).blob();
      const img=await createImageBitmap(imgBlob);
      const cell=Math.max(4,Math.min(48,Number(cellSize)||8));
      const gridW=Math.max(1,Math.floor(img.width/cell));
      const gridH=Math.max(1,Math.floor(img.height/cell));
      const w=gridW*cell,h=gridH*cell;
      const off=new OffscreenCanvas(w,h);
      const ctx=off.getContext('2d');
      ctx.drawImage(img,0,0,w,h);

      const id=ctx.getImageData(0,0,w,h).data;
      const cells=[];
      for(let gy=0;gy<gridH;gy++){
        const row=[];
        for(let gx=0;gx<gridW;gx++){
          let sr=0,sg=0,sb=0,cnt=0;
          for(let yy=gy*cell;yy<(gy+1)*cell;yy++){
            for(let xx=gx*cell;xx<(gx+1)*cell;xx++){
              const i=(yy*w+xx)*4;
              sr+=id[i]; sg+=id[i+1]; sb+=id[i+2]; cnt++;
            }
          }
          const lum=Math.round(0.299*(sr/cnt)+0.587*(sg/cnt)+0.114*(sb/cnt));
          row.push({black: lum<=bwThreshold?1:0});
        }
        cells.push(row);
      }

      const stitchPoints=[];
      for(let gy=0;gy<gridH;gy++){
        for(let gx=0;gx<gridW;gx++){
          if(!cells[gy][gx].black) continue;
          const x0=gx*cell,y0=gy*cell;
          const x1=x0+cell,y1=y0+cell;
          stitchPoints.push([x0,y0],[x1,y1],[x0,y1],[x1,y0]);
        }
      }

      if(stitchPoints.length<2) stitchPoints.push([0,0],[10,10]);
      const scale=Number(exportScale)||0.2;
      const dstCoords=stitchPoints.map(p=>[p[0]*scale,p[1]*scale]);
      postMessage({dstCoords, merged:dstCoords, w, h});
    }catch(err){ postMessage({error:err.message||String(err)}); }
  };
});

const fileInput=document.getElementById('file');
const btn=document.getElementById('process');
const createBtn=document.getElementById('createDST');
const saveBtn=document.getElementById('saveDST');
const downloadBtn=document.getElementById('downloadDST');
const preview=document.getElementById('svgPreview');

let merged=[], dstFile=null;

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù…Ø®Ø·Ø· ØºØ±Ø²
btn.addEventListener('click',()=>{
  const f=fileInput.files[0];
  if(!f){ alert('Ø§Ø®ØªØ± ØµÙˆØ±Ø©'); return; }
  const reader=new FileReader();
  reader.onload=()=>worker.postMessage({
    dataURL:reader.result,
    cellSize:Number(document.getElementById('cellSize').value||8),
    bwThreshold:Number(document.getElementById('bwThreshold').value||128),
    stitchStep:Number(document.getElementById('stitchStep').value||4),
    exportScale:Number(document.getElementById('exportScale').value||0.2)
  });
  reader.readAsDataURL(f);
});

worker.onmessage=ev=>{
  if(ev.data.error){ log('Ø®Ø·Ø£: '+ev.data.error); return; }
  merged = ev.data.merged;
  log('ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© â€” Ù†Ù‚Ø§Ø·: '+ev.data.dstCoords.length);

  // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù DST
  createBtn.disabled = false;

  let svg=`<svg xmlns='http://www.w3.org/2000/svg' width='${ev.data.w}' height='${ev.data.h}' viewBox='0 0 ${ev.data.w} ${ev.data.h}'>`;
  svg+=`<rect width='100%' height='100%' fill='white'></rect>`;
  svg+=`<g stroke='black' stroke-width='1' stroke-linecap='round'>`;
  svg+=`<polyline fill='none' points='${merged.map(p=>p[0]+','+p[1]).join(' ')}'/>`;
  svg+=`</g></svg>`;
  preview.innerHTML=`<object type="image/svg+xml" data="data:image/svg+xml;base64,${btoa(svg)}" style="width:100%;height:100%"></object>`;
};

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù DST ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ØªØµÙ…ÙŠÙ…
createBtn.addEventListener('click',()=>{
  if(!merged.length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙ…ÙŠÙ… Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù'); return; }
  dstFile = buildDST(merged); // Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø§Ù„ØªØµÙ…ÙŠÙ… Ù…Ø¨Ø§Ø´Ø±Ø©
  log('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù DST ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¯Ø§Ø®Ù„Ù‡');
  saveBtn.disabled = false; // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø­ÙØ¸ Ø§Ù„ØªØµÙ…ÙŠÙ…
});

// Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù (ÙØ¹Ù„ÙŠÙ‹Ø§ Ù…Ø¬Ø±Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù‡Ù†Ø§)
saveBtn.addEventListener('click',()=>{
  if(!dstFile){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù„Ø­ÙØ¸Ù‡'); return; }
  // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„
  log('ØªÙ… Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù');
  downloadBtn.disabled = false; // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„ØªÙ†Ø²ÙŠÙ„
});

// ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
downloadBtn.addEventListener('click',()=>{
  if(!dstFile){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù„Ù„ØªÙ†Ø²ÙŠÙ„'); return; }
  forceDownload(new Blob([dstFile],{type:'application/octet-stream'}),'molfa_output.dst');
  log('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ');
});
</script>
</body>
</html>
