<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Molfa — شبكة تطريز صحيحة</title>
<style>
body{font-family:Arial; background:#f3f4f6; color:#111;}
.svg-wrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center;}
.svg-wrap svg,.svg-wrap object{width:100%;height:100%;}
button{cursor:pointer;margin-top:5px;}
</style>
</head>
<body>
<h2>Molfa — شبكة تطريز صحيحة</h2>
<input id="file" type="file" accept="image/*"/>
<br>
حجم الخلية: <input id="cellSize" type="number" value="8" min="4" max="40"/>
<br>
عتبة B/W: <input id="bwThreshold" type="range" min="0" max="255" value="128"/>
<br>
طول الغرزة: <input id="stitchStep" type="number" value="4" min="1" max="16"/>
<br>
مقياس التصدير: <input id="exportScale" type="number" value="0.2" step="0.05" min="0.05" max="5"/>
<br>
<button id="process">توليد DST + معاينة</button>
<div id="svgPreview" class="svg-wrap">لم يتم التوليد بعد</div>
<div id="downloadBtns"></div>

<script>
function forceDownload(blob,name){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),2000);
}

function buildDST(coords){
  const header=new Uint8Array(512);
  const body=[]; let prevx=0, prevy=0;
  coords.forEach(p=>{
    let dx=p[0]-prevx, dy=p[1]-prevy;
    while(Math.abs(dx)>121||Math.abs(dy)>121){
      const sx=Math.max(-121,Math.min(121,dx));
      const sy=Math.max(-121,Math.min(121,dy));
      body.push(sx&0xFF, sy&0xFF, 0x01); dx-=sx; dy-=sy; prevx+=sx; prevy+=sy;
    }
    body.push(dx&0xFF, dy&0xFF, 0x03); prevx=p[0]; prevy=p[1];
  });
  body.push(0x00,0x00,0xF3);
  const arr=new Uint8Array(512+body.length);
  arr.set(header,0); arr.set(new Uint8Array(body),512);
  return arr;
}

document.getElementById('process').onclick=()=>{
  const f=document.getElementById('file').files[0];
  if(!f){ alert('اختر صورة'); return; }
  const reader=new FileReader();
  reader.onload=()=>{
    const img=new Image();
    img.src=reader.result;
    img.onload=()=>{
      const cell=Number(document.getElementById('cellSize').value);
      const bw=Number(document.getElementById('bwThreshold').value);
      const step=Number(document.getElementById('stitchStep').value);
      const scale=Number(document.getElementById('exportScale').value);

      const w=img.width,h=img.height;
      const c=document.createElement('canvas'); c.width=w;c.height=h;
      const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      const id=ctx.getImageData(0,0,w,h).data;

      const stitchPoints=[];
      const gridW=Math.floor(w/cell), gridH=Math.floor(h/cell);
      for(let gy=0;gy<gridH;gy++){
        for(let gx=0;gx<gridW;gx++){
          let sum=0,cnt=0;
          for(let yy=gy*cell;yy<(gy+1)*cell;yy++){
            for(let xx=gx*cell;xx<(gx+1)*cell;xx++){
              const i=(yy*w+xx)*4;
              sum+=0.299*id[i]+0.587*id[i+1]+0.114*id[i+2]; cnt++;
            }
          }
          if(sum/cnt<=bw){
            const x0=gx*cell,y0=gy*cell,x1=x0+cell,y1=y0+cell;
            const n=Math.max(1,Math.ceil(cell/step));
            for(let i=0;i<=n;i++){ const t=i/n; stitchPoints.push([x0+(x1-x0)*t,y0+(y1-y0)*t]); }
            for(let i=0;i<=n;i++){ const t=i/n; stitchPoints.push([x1+(x0-x1)*t,y0+(y1-y0)*t]); }
          }
        }
      }

      const dstCoords=stitchPoints.map(p=>[Math.round(p[0]*scale),Math.round(p[1]*scale)]);
      const dstBlob=new Blob([buildDST(dstCoords)],{type:'application/octet-stream'});

      // SVG preview
      let svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}"><image href="${reader.result}" width="${w}" height="${h}"/><g stroke="black" stroke-width="1">`;
      stitchPoints.forEach(p=>{ svg+=`<circle cx="${p[0]}" cy="${p[1]}" r="0.5" fill="black"/>`; });
      svg+='</g></svg>';
      document.getElementById('svgPreview').innerHTML=`<object type="image/svg+xml" data="data:image/svg+xml;base64,${btoa(svg)}" style="width:100%;height:100%"></object>`;

      const dl=document.getElementById('downloadBtns'); dl.innerHTML='';
      const btnDST=document.createElement('button'); btnDST.textContent='⬇️ DST صحيح'; btnDST.onclick=()=>forceDownload(dstBlob,'molfa_output.dst');
      dl.appendChild(btnDST);
    };
  };
  reader.readAsDataURL(f);
};
</script>
</body>
</html>
