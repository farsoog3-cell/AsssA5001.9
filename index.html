<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mlfa2026 — تحويل صورة إلى غرز احترافي</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: Inter, sans-serif; background:#f3f4f6; color:#111; }
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; background:#111; color:#fff; padding:0.5rem; border-radius:0.25rem;}
  canvas { display:none; }
</style>
</head>
<body class="flex flex-col items-center p-4">

<header class="text-center mb-4">
  <h1 class="text-2xl font-bold">mlfa2026 — تحويل صورة → غرز بدون خلفية</h1>
  <p class="text-sm">تم تطوير الموقع من قبل: ملهم (المبرمج) وفارس (المطور). عمل مشترك في إنتاج هذا الموقع.</p>
</header>

<div class="flex flex-col md:flex-row gap-4 w-full max-w-4xl">
  <div class="flex flex-col gap-3 md:w-1/3">
    <label class="font-medium">اختر صورة</label>
    <input type="file" id="file" accept="image/*" class="p-2 border rounded"/>

    <label>عدد الألوان</label>
    <input id="colors" type="number" value="4" min="1" max="12" class="p-2 border rounded"/>

    <label>طول الغرزة (px)</label>
    <input id="stitchLen" type="number" value="4" min="1" max="40" class="p-2 border rounded"/>

    <label>تباعد الغرز (px)</label>
    <input id="stitchGap" type="number" value="4" min="1" max="40" class="p-2 border rounded"/>

    <label>زاوية الغرز (°)</label>
    <input id="angle" type="number" value="45" min="0" max="180" class="p-2 border rounded"/>

    <button id="process" class="bg-indigo-600 text-white py-2 rounded">🔧 توليد الغرز</button>
  </div>

  <div class="md:w-2/3 flex flex-col gap-3">
    <div id="svgPreview" class="w-full h-80 border rounded flex items-center justify-center text-gray-500">
      لم يتم التوليد بعد
    </div>

    <pre id="log" class="mono h-40 overflow-auto"></pre>
  </div>
</div>

<canvas id="work"></canvas>

<script>
function log(msg){ const el=document.getElementById('log'); el.textContent+=msg+'\n'; el.scrollTop=el.scrollHeight; }

async function readFileAsImage(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = e=>{
      const img = new Image();
      img.onload = ()=>res(img);
      img.onerror=rej;
      img.src=e.target.result;
    };
    fr.onerror=rej;
    fr.readAsDataURL(file);
  });
}

function removeBackground(img, threshold=250){
  const c = document.getElementById('work');
  c.width = img.width; c.height = img.height;
  const ctx = c.getContext('2d');
  ctx.drawImage(img,0,0);
  const id = ctx.getImageData(0,0,img.width,img.height);
  for(let i=0;i<id.data.length;i+=4){
    const r=id.data[i],g=id.data[i+1],b=id.data[i+2];
    if(r>threshold && g>threshold && b>threshold){ id.data[i+3]=0; }
  }
  ctx.putImageData(id,0,0);
  return c;
}

function generateStitches(canvas){
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const id = ctx.getImageData(0,0,w,h);
  const visited = new Uint8Array(w*h);
  const paths=[];
  function getIndex(x,y){ return y*w + x; }

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const idx = getIndex(x,y);
      if(visited[idx]) continue;
      const a = id.data[idx*4+3];
      if(a<128) continue;
      const stack=[[x,y]];
      const path=[];
      visited[idx]=1;
      while(stack.length){
        const [cx,cy]=stack.pop();
        path.push([cx,cy]);
        const dirs=[[1,0],[-1,0],[0,1],[0,-1]];
        for(const [dx,dy] of dirs){
          const nx=cx+dx, ny=cy+dy;
          if(nx<0||ny<0||nx>=w||ny>=h) continue;
          const nidx = getIndex(nx,ny);
          if(visited[nidx]) continue;
          if(id.data[nidx*4+3]>=128){ visited[nidx]=1; stack.push([nx,ny]); }
        }
      }
      if(path.length>5) paths.push(path);
    }
  }
  return paths;
}

function buildSVG(paths, w, h){
  let svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}' viewBox='0 0 ${w} ${h}'>`;
  svg += `<rect width='100%' height='100%' fill='transparent'/>`;
  svg += `<g stroke="black" stroke-width="1" fill="none">`;
  for(const path of paths){ svg+=`<path d="M${path.map(p=>p.join(',')).join(' L')}"/>`; }
  svg+='</g></svg>';
  return svg;
}

function buildDst(paths){
  const arr = [];
  for(const path of paths){
    for(const p of path){
      arr.push(p[0] & 0xFF, p[1] & 0xFF, 0x00);
    }
  }
  arr.push(0x00,0x00,0xF3);
  return new Uint8Array(arr);
}

document.getElementById('process').addEventListener('click', async ()=>{
  const file=document.getElementById('file').files[0];
  if(!file){ alert('اختر صورة أولاً'); return; }
  log('تحميل الصورة...');
  const img = await readFileAsImage(file);
  log('إزالة الخلفية...');
  const canvas = removeBackground(img);
  log('توليد مسارات الغرز...');
  const paths = generateStitches(canvas);
  log(`عدد المسارات: ${paths.length}`);

  log('بناء SVG...');
  const svg = buildSVG(paths,canvas.width,canvas.height);
  const svgBlob = new Blob([svg],{type:'image/svg+xml'});
  const svgURL = URL.createObjectURL(svgBlob);

  const dstArr = buildDst(paths);
  const dstBlob = new Blob([dstArr],{type:'application/octet-stream'});
  const dstURL = URL.createObjectURL(dstBlob);

  const preview=document.getElementById('svgPreview');
  preview.innerHTML=`<object type="image/svg+xml" data="${svgURL}" style="width:100%; height:100%; display:block;"></object>`;

  const dlDiv = document.createElement('div'); dlDiv.className='mt-2 flex gap-2';
  const a1=document.createElement('a'); a1.href=svgURL; a1.download='pattern.svg'; a1.textContent='⬇️ تحميل SVG'; a1.className='bg-blue-600 text-white py-1 px-2 rounded';
  const a2=document.createElement('a'); a2.href=dstURL; a2.download='pattern.dst'; a2.textContent='⬇️ تحميل DST'; a2.className='bg-green-600 text-white py-1 px-2 rounded';
  dlDiv.appendChild(a1); dlDiv.appendChild(a2); preview.appendChild(dlDiv);

  log('تم التوليد بنجاح. استخدم الأزرار لتحميل الملفات.');
});
</script>

</body>
</html>
